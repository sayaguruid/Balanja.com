<!DOCTYPE html>
<html lang="id">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balanja</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" media="print" onload="this.media='all'">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" href="2.png" type="image/png">
   
    <style>
        body { font-family: 'Inter', sans-serif; }
        .product-card, .cart-item { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .loader { border: 4px solid #e5e7eb; border-top: 4px solid #4f46e5; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .skeleton { animation: pulse 1.5s infinite ease-in-out; background: #f3f4f6; border-radius: 8px; }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 0.5; } 100% { opacity: 0.8; } }
        .checkout-sidebar { width: 100%; max-width: 450px; }
        @media (min-width: 768px) { .checkout-sidebar { width: 450px; } }
        .copy-feedback { position: relative; }
        .copy-feedback:after {
            content: "Tersalin!";
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4ade80;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .copy-feedback.show:after {
            opacity: 1;
        }
        
        /* Notifikasi Popup yang Diperbaiki */
        .notification-container {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 9999;
            max-width: 350px;
        }
        
        .notification-item {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            transform: translateX(400px);
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border-left: 4px solid #10b981;
            opacity: 0;
        }
        
        .notification-item.show {
            transform: translateX(0);
            opacity: 1;
        }
        
        .notification-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            flex-shrink: 0;
            overflow: hidden;
        }
        
        .notification-content {
            flex-grow: 1;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 14px;
            color: #111827;
            margin-bottom: 4px;
        }
        
        .notification-message {
            font-size: 13px;
            color: #6b7280;
            line-height: 1.4;
        }
        
        .notification-time {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            margin-left: 8px;
        }
        
        .notification-close:hover {
            color: #6b7280;
        }
        
        /* Animasi untuk notifikasi yang masuk */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Animasi untuk notifikasi yang keluar */
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .notification-item.slide-in {
            animation: slideIn 0.5s forwards;
        }
        
        .notification-item.slide-out {
            animation: slideOut 0.5s forwards;
        }
        
        /* Preview Gambar Bukti Pembayaran */
        .preview-container {
            margin-top: 16px;
            position: relative;
            display: none;
        }
        
        .preview-container.show {
            display: block;
        }
        
        .preview-image {
            width: 100%;
            max-height: 300px;
            object-fit: contain;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }
        
        .remove-preview {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .remove-preview:hover {
            background-color: rgba(239, 68, 68, 1);
        }
    </style>
    
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">
    <!-- Notifikasi Popup yang Diperbaiki -->
    <div id="notification-container" class="notification-container"></div>

    <main class="flex-1 p-4 md:p-8">
        <header class="flex flex-col items-center mb-6 text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight">Balanja.co.id</h1>
            <p class="mt-2 text-base text-gray-500">Temukan produk favorit Anda dengan mudah.</p>
        </header>

        <div class="max-w-xl mx-auto bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Daftar Produk</h2>
            <div id="loading-message" class="space-y-4 mt-4">
                <div class="flex items-center p-4 bg-white rounded-xl shadow-sm border border-gray-100">
                    <div class="w-16 h-16 mr-4 skeleton"></div>
                    <div class="flex-1 space-y-2">
                        <div class="h-4 w-3/4 skeleton"></div>
                        <div class="h-6 w-1/2 skeleton"></div>
                    </div>
                    <div class="w-8 h-8 rounded-full skeleton"></div>
                </div>
            </div>
            <div id="products-list" class="space-y-4 hidden"></div>
        </div>
    </main>

    <div class="fixed bottom-4 left-1/2 -translate-x-1/2 w-[90%] md:w-[400px] z-50">
        <button id="cart-icon" class="w-full h-14 bg-gray-800 text-white font-bold text-lg rounded-xl shadow-xl flex items-center justify-between px-6 py-2 transition-all duration-300 transform hover:scale-[1.02]">
            <div class="flex items-center space-x-2">
                <div id="cart-count-badge" class="bg-white text-gray-800 font-bold w-6 h-6 rounded-full flex items-center justify-center text-sm hidden">0</div>
                <span>Keranjang</span>
            </div>
            <span id="total-price-button">Rp 0</span>
        </button>
    </div>

    <div id="cart-sidebar" class="fixed top-0 right-0 w-full max-w-sm md:w-96 h-full bg-white shadow-2xl transform translate-x-full transition-transform ease-in-out duration-300 p-6 flex flex-col z-50">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Keranjang</h3>
            <button id="close-cart" class="p-1 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <div id="cart-items" class="flex-1 overflow-y-auto space-y-4 text-sm text-gray-700">
            <p id="cart-placeholder" class="text-center text-gray-400 mt-10">Keranjang Anda kosong.</p>
        </div>
        <div class="mt-6 pt-4 border-t border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <span class="text-lg font-bold text-gray-800">Total:</span>
                <span id="total-price" class="text-2xl font-extrabold text-gray-800">Rp 0</span>
            </div>
            <button id="checkout-button" class="w-full text-center bg-gray-800 text-white font-bold py-3 rounded-xl hover:bg-gray-900 transition block disabled:bg-gray-400 disabled:cursor-not-allowed shadow-md">
                Checkout
            </button>
        </div>
    </div>

    <div id="checkout-sidebar" class="checkout-sidebar fixed top-0 right-0 h-full bg-white shadow-2xl transform translate-x-full transition-transform ease-in-out duration-300 p-6 flex flex-col z-50 overflow-y-auto">
        <div class="flex justify-between items-center mb-6 sticky top-0 bg-white pt-0 pb-4 z-10 border-b border-gray-100">
            <h3 class="text-2xl font-bold text-gray-800">Selesaikan Pesanan</h3>
            <button id="close-checkout" class="p-1 rounded-full text-gray-500 hover:text-gray-700 hover:bg-gray-100 transition">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <form id="checkout-form" class="space-y-6 flex-1 flex flex-col">
            <div class="flex-1 overflow-y-auto pr-2">
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Detail Pelanggan</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="customerName" class="block text-sm font-medium text-gray-700">Nama</label>
                            <input type="text" id="customerName" name="customerName" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-gray-500 focus:ring focus:ring-gray-200 focus:ring-opacity-50 py-3 px-4">
                        </div>
                        <div>
                            <label for="customerNumber" class="block text-sm font-medium text-gray-700">Nomor WhatsApp</label>
                            <input type="tel" id="customerNumber" name="customerNumber" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-gray-500 focus:ring focus:ring-gray-200 focus:ring-opacity-50 py-3 px-4">
                        </div>
                        <div>
                            <label for="customerAddress" class="block text-sm font-medium text-gray-700">Alamat</label>
                            <textarea id="customerAddress" name="customerAddress" rows="3" required class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-gray-500 focus:ring focus:ring-gray-200 focus:ring-opacity-50 py-2 px-4"></textarea>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner mb-6">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Ringkasan Pesanan</h2>
                    <ul id="order-items" class="space-y-2 text-sm"></ul>
                </div>
                <div class="bg-gray-50 p-6 rounded-xl shadow-inner">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Metode Pembayaran</h2>
                    <div class="space-y-2">
                        <label class="flex items-center p-3 rounded-lg bg-white shadow-sm border border-gray-200 cursor-pointer hover:bg-gray-100 transition">
                            <input type="radio" name="paymentMethod" value="COD" required class="form-radio text-gray-800 focus:ring-gray-500">
                            <span class="ml-3 text-sm font-medium text-gray-700">COD (Bayar di Tempat)</span>
                        </label>
                        <label class="flex items-center p-3 rounded-lg bg-white shadow-sm border border-gray-200 cursor-pointer hover:bg-gray-100 transition">
                            <input type="radio" name="paymentMethod" value="QRIS" required class="form-radio text-gray-800 focus:ring-gray-500">
                            <span class="ml-3 text-sm font-medium text-gray-700">QRIS</span>
                        </label>
                        <label class="flex items-center p-3 rounded-lg bg-white shadow-sm border border-gray-200 cursor-pointer hover:bg-gray-100 transition">
                            <input type="radio" name="paymentMethod" value="BSI" required class="form-radio text-gray-800 focus:ring-gray-500">
                            <span class="ml-3 text-sm font-medium text-gray-700">BSI</span>
                        </label>
                    </div>
                    <div id="payment-details-container" class="hidden text-center mt-4 p-4 bg-gray-200 rounded-lg">
                        <div id="qris-container" class="hidden">
                             <p class="text-sm text-gray-600 mb-2">Pindai QRIS di bawah ini:</p>
                             <img id="qris-image-checkout" src="" alt="QRIS Code" class="mx-auto rounded-lg w-full max-w-[200px] shadow-md">
                        </div>
                        <div id="bsi-container" class="hidden text-left">
                            <p class="text-sm font-bold text-gray-800 mb-2">Transfer ke Bank Syariah Indonesia (BSI):</p>
                            <div class="flex items-center justify-between bg-white p-3 rounded-lg">
                                <div>
                                    <p class="text-lg font-bold text-gray-700">1042896434</p>
                                    <p class="text-sm text-gray-600">A.N. Usman Firdaus</p>
                                </div>
                                <button type="button" id="copy-account-btn" class="copy-feedback bg-gray-800 text-white px-3 py-2 rounded-lg hover:bg-gray-700 transition flex items-center gap-2">
                                    <i class="fas fa-copy"></i>
                                    <span>Salin</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="upload-proof-container" class="bg-gray-50 p-6 rounded-xl shadow-inner mt-6 hidden">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Bukti Pembayaran</h2>
                    <div>
                        <label for="paymentProofFile" class="block text-sm font-medium text-gray-700">Unggah Bukti Transaksi (JPG/PNG)</label>
                        <input type="file" id="paymentProofFile" accept="image/jpeg, image/png" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-gray-500 focus:ring focus:ring-gray-200 focus:ring-opacity-50 py-3 px-4 bg-white">
                        <p class="text-xs text-gray-500 mt-1">File akan diunggah ke sistem.</p>
                        
                        <!-- Preview Container -->
                        <div id="preview-container" class="preview-container">
                            <img id="preview-image" class="preview-image" alt="Preview Bukti Pembayaran">
                            <button type="button" id="remove-preview" class="remove-preview">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div id="upload-status" class="hidden text-sm mt-2 text-gray-600"></div>
                    </div>
                </div>
            </div>
            <div class="mt-6 pt-4 border-t border-gray-200 sticky bottom-0 bg-white">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-lg font-bold text-gray-800">Total:</span>
                    <span id="order-total" class="text-2xl font-extrabold text-gray-800">Rp 0</span>
                </div>
                <button type="submit" id="place-order-button" class="w-full bg-gray-800 text-white font-bold py-3 rounded-xl hover:bg-gray-900 transition shadow-lg">
                    <span id="submit-text">Selesaikan Pesanan</span>
                    <div id="submit-loader" class="loader mx-auto hidden"></div>
                </button>
            </div>
        </form>
    </div>

    <div id="variant-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 class="text-xl font-bold text-gray-800 mb-4" id="variant-modal-title">Pilih Varian</h3>
            <div id="variant-options" class="space-y-3 max-h-60 overflow-y-auto pr-2">
                </div>
            <div class="mt-6 flex justify-end space-x-3">
                <button id="close-variant-modal" class="py-2 px-4 text-sm font-medium text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">Batal</button>
                <button id="add-variant-to-cart" class="py-2 px-4 text-sm font-bold text-white bg-gray-800 rounded-lg hover:bg-gray-900 transition disabled:bg-gray-400" disabled>Tambahkan ke Keranjang</button>
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 hidden z-[60]">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <a id="modal-link" href="#" target="_blank" class="hidden text-indigo-600 underline hover:text-indigo-800 font-medium mb-6">Lihat Status Pesanan</a>
            <a id="whatsapp-button" href="#" target="_blank"
               class="hidden w-full bg-[#25D366] text-white font-semibold py-3 px-5 rounded-xl
                      shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center gap-3">
                
                <!-- Ikon WhatsApp bulat -->
                <div class="bg-white p-2 rounded-full">
                    <svg class="w-6 h-6" fill="#25D366" viewBox="0 0 32 32">
                        <path d="M16.001 3.2c-7.063 0-12.8 5.736-12.8 12.8 0 2.256.592 4.457 1.712 6.4L3.2 28.8l6.592-1.696c1.856.992 3.952 1.52 6.208 1.52h.001c7.063 0 12.8-5.736 12.8-12.8s-5.737-12.8-12.8-12.8zm0 23.04h-.001c-1.92 0-3.792-.512-5.44-1.472l-.384-.224-3.904 1.008 1.04-3.808-.256-.4A10.43 10.43 0 0 1 5.6 16c0-5.76 4.64-10.4 10.4-10.4s10.4 4.64 10.4 10.4-4.64 10.4-10.399 10.4z"/>
                        <path d="M22.24 19.52c-.384-.192-2.272-1.12-2.624-1.248-.352-.128-.608-.192-.864.192-.256.384-1.008 1.248-1.232 1.504-.224.256-.448.288-.832.096-2.24-1.12-3.712-3.968-3.84-4.224-.128-.256-.013-.384.128-.512.128-.128.256-.32.384-.480.128-.16.192-.288.288-.48.096-.192.048-.352-.016-.496-.064-.144-.864-2.048-1.184-2.816-.32-.768-.656-.672-.864-.672s-.48-.032-.736-.032c-.256 0-.672.096-1.024.48-.352.384-1.344 1.312-1.344 3.2 0 1.888 1.376 3.712 1.568 3.968.192.256 2.704 4.128 6.592 5.76.92.4 1.637.64 2.194.819.92.293 1.756.252 2.419.153.738-.11 2.272-.928 2.592-1.824.32-.896.32-1.664.224-1.824-.096-.16-.352-.256-.736-.448z"/>
                    </svg>
                </div>

                <span class="text-lg font-bold tracking-wide">Hubungi Admin</span>
            </a>

            <button id="modal-close" class="bg-gray-800 text-white font-bold py-2 px-6 rounded-lg hover:bg-gray-900 transition mt-4">Tutup</button>
        </div>
    </div>

    <footer class="mt-8 mb-20 text-center text-sm text-gray-400">
        Â© 2025 PT. UMKM | All Rights Reserved 
    </footer>
    
    <script src="https://script.google.com/macros/s/AKfycbzPsZGLIA1MOLMmc_63mFcNHmoCVALlCBtZ6PuV5gPYfss3VAjBKvAnYJceHbAOXkNK/exec" defer></script>

    <script>
        let products = [];
        let qrisUrl = "";
        let cart = {};
        let selectedVariantId = null; // Menyimpan ID produk utama yang variannya sedang dipilih
        let lastOrderCount = 0; // Menyimpan jumlah pesanan terakhir
        let notifications = []; // Menyimpan notifikasi yang aktif

        const currencyFormatter = new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 });
        
        // Elemen Produk & Keranjang
        const productsList = document.getElementById('products-list');
        const cartSidebar = document.getElementById('cart-sidebar');
        const cartIconButton = document.getElementById('cart-icon');
        const closeCartButton = document.getElementById('close-cart');
        const cartItemsList = document.getElementById('cart-items');
        const totalPriceEl = document.getElementById('total-price');
        const totalPriceButtonEl = document.getElementById('total-price-button');
        const cartCountEl = document.getElementById('cart-count-badge');
        const checkoutButton = document.getElementById('checkout-button');
        const cartPlaceholder = document.getElementById('cart-placeholder');
        const loadingMessage = document.getElementById('loading-message');
        
        // Elemen Checkout
        const checkoutSidebar = document.getElementById('checkout-sidebar');
        const closeCheckoutButton = document.getElementById('close-checkout');
        const orderItemsList = document.getElementById('order-items');
        const orderTotalEl = document.getElementById('order-total');
        const checkoutForm = document.getElementById('checkout-form');
        const placeOrderButton = document.getElementById('place-order-button');
        const paymentMethodRadios = document.getElementsByName('paymentMethod');
        const submitText = document.getElementById('submit-text');
        const submitLoader = document.getElementById('submit-loader');
        const paymentDetailsContainer = document.getElementById('payment-details-container');
        const qrisContainer = document.getElementById('qris-container');
        const bsiContainer = document.getElementById('bsi-container');
        const uploadProofContainer = document.getElementById('upload-proof-container');
        const paymentProofFile = document.getElementById('paymentProofFile'); // Input file
        const uploadStatusEl = document.getElementById('upload-status'); // Status upload
        const copyAccountBtn = document.getElementById('copy-account-btn'); // Tombol copy nomor rekening
        
        // Elemen Preview Gambar
        const previewContainer = document.getElementById('preview-container');
        const previewImage = document.getElementById('preview-image');
        const removePreviewBtn = document.getElementById('remove-preview');
        
        // Elemen Modal
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalLink = document.getElementById('modal-link');
        const modalClose = document.getElementById('modal-close');
        const whatsappButton = document.getElementById('whatsapp-button');
        
        // Elemen Modal Varian (BARU)
        const variantModal = document.getElementById('variant-modal');
        const variantModalTitle = document.getElementById('variant-modal-title');
        const variantOptionsContainer = document.getElementById('variant-options');
        const closeVariantModalButton = document.getElementById('close-variant-modal');
        const addVariantToCartButton = document.getElementById('add-variant-to-cart');

        // Elemen Notifikasi
        const notificationContainer = document.getElementById('notification-container');

        // --- FUNGSI CORE ---

        function getProduct(id, variantName = null) {
            const product = products.find(p => p.id === id);
            if (!product) return null;

            if (variantName && product.variants && product.variants.length > 0) {
                const variant = product.variants.find(v => v.name === variantName);
                if (variant) {
                    return {
                        ...product,
                        variantName: variant.name,
                        price: variant.price,
                        stock: variant.stock, 
                        uniqueId: `${id}-${variant.name}` 
                    };
                }
            }
            // Untuk produk utama tanpa varian
            return {
                ...product,
                uniqueId: id,
                stock: product.stock
            };
        }

        function updateCartItem(productId, variantName = null) {
            const product = getProduct(productId, variantName);
            if (!product) return;

            const uniqueId = product.uniqueId;
            const productInCart = cart[uniqueId];

            if (productInCart) {
                if (productInCart.quantity < product.stock) {
                    productInCart.quantity++;
                } else {
                    showModal('Stok Habis', `Stok untuk produk "${product.name}${product.variantName ? ' (' + product.variantName + ')' : ''}" sudah habis.`, false);
                }
            } else {
                if (product.stock > 0) {
                    cart[uniqueId] = { ...product, quantity: 1 };
                } else {
                    showModal('Stok Habis', `Stok untuk produk "${product.name}${product.variantName ? ' (' + product.variantName + ')' : ''}" saat ini kosong.`, false);
                }
            }
            renderProducts(products); // Render ulang untuk update stok
            renderCart();
            saveCart();
        }

        function decrementQuantity(uniqueId) {
            if (cart[uniqueId]) {
                cart[uniqueId].quantity--;
                if (cart[uniqueId].quantity <= 0) {
                    delete cart[uniqueId];
                }
            }
            renderProducts(products); 
            renderCart();
            saveCart();
        }

        function saveCart() { localStorage.setItem('cart', JSON.stringify(cart)); }
        
        function loadCart() {
            try {
                const savedCart = localStorage.getItem('cart');
                if (savedCart) {
                    const parsedCart = JSON.parse(savedCart);
                    cart = Object.fromEntries(
                        Object.entries(parsedCart).filter(([uniqueId, item]) => {
                            const productId = item.id;
                            const variantName = item.variantName;
                            const product = getProduct(productId, variantName);
                            
                            if (product && product.stock > 0) {
                                item.price = product.price;
                                item.stock = product.stock;
                                if (item.quantity > item.stock) {
                                    item.quantity = item.stock;
                                }
                                return item.quantity > 0;
                            }
                            return false;
                        })
                    );
                }
            } catch (e) {
                console.error("Failed to load cart from local storage", e);
                cart = {};
            }
        }

        function calculateTotal() {
            const total = Object.values(cart).reduce((sum, item) => sum + (item.price * item.quantity), 0);
            totalPriceEl.textContent = currencyFormatter.format(total);
            totalPriceButtonEl.textContent = currencyFormatter.format(total);
        }

        function updateCartCount() {
            const count = Object.values(cart).reduce((sum, item) => sum + item.quantity, 0);
            cartCountEl.textContent = count;
            if (count > 0) { cartCountEl.classList.remove('hidden'); } else { cartCountEl.classList.add('hidden'); }
        }

        // --- RENDER & UI ---

        /**
         * Merender daftar produk (hanya menampilkan produk utama).
         */
        function renderProducts(productsData) {
            products = productsData;
            productsList.innerHTML = '';
            
            if (products.length === 0) {
                productsList.innerHTML = `<p class="text-center text-gray-400">Tidak ada produk yang tersedia.</p>`;
            } else {
                products.forEach(product => {
                    const productCard = createProductCard(product);
                    productsList.appendChild(productCard);
                });
            }
            loadingMessage.classList.add('hidden');
            productsList.classList.remove('hidden');

            document.querySelectorAll('.add-product-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = parseInt(e.currentTarget.dataset.id);
                    const product = products.find(p => p.id === productId);

                    if (product && product.hasVariants && product.variants && product.variants.length > 0) {
                        openVariantModal(productId, product.variants);
                    } else if (product && product.stock > 0) {
                        // Jika tidak ada varian dan stok ada, langsung tambahkan
                        updateCartItem(productId);
                    } else {
                        showModal('Stok Habis', `Stok untuk produk "${product.name}" saat ini kosong.`, false);
                    }
                });
            });
        }
        
        /**
         * Membuat elemen kartu produk HTML.
         */
        function createProductCard(product) {
            // Tentukan harga/stok yang ditampilkan: harga termurah atau harga base.
            let displayPrice = product.price;
            let displayStock = product.stock;
            let labelText = "Tambah";
            
            if (product.hasVariants && product.variants && product.variants.length > 0) {
                const minPrice = Math.min(...product.variants.map(v => v.price));
                displayPrice = minPrice;
                displayStock = product.variants.reduce((sum, v) => sum + v.stock, 0);
                labelText = "Pilih Varian";
            }
            
            const isOutOfStock = displayStock <= 0;
            const buttonText = isOutOfStock ? 'Stok Habis' : (product.hasVariants ? 'Pilih Varian' : '+');
            const buttonClass = isOutOfStock ? 'bg-red-400 text-white cursor-not-allowed' : 'bg-gray-800 text-white hover:bg-gray-900';
            
            const productCard = document.createElement('div');
            productCard.className = 'product-card flex items-center p-4 bg-white rounded-xl shadow-md border border-gray-100';
            
            productCard.innerHTML = `
                ${product.imageLink ? `<img src="${product.imageLink}" alt="${product.name}" class="w-16 h-16 object-cover rounded-lg mr-4" loading="lazy">` : ''}
                <div class="flex-1">
                    <h3 class="font-semibold text-gray-800">${product.name}</h3>
                    <p class="text-lg font-bold text-gray-600">${currencyFormatter.format(displayPrice)} ${product.hasVariants ? `<span>+</span>` : ''}</p>
                    <p class="text-xs text-gray-500 mt-1">Stok Total: <span class="${isOutOfStock ? 'text-red-500 font-bold' : 'text-green-500 font-bold'}">${displayStock}</span></p>
                </div>
                <button data-id="${product.id}" class="add-product-btn font-bold w-10 h-10 rounded-full flex items-center justify-center transition duration-300 ${buttonClass}" ${isOutOfStock ? 'disabled' : ''}>
                    ${product.hasVariants ? `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>` : '+'}
                </button>
            `;
            return productCard;
        }

        function renderCart() {
            cartItemsList.innerHTML = '';
            const cartItems = Object.values(cart);
            
            if (cartItems.length === 0) {
                cartPlaceholder.classList.remove('hidden');
                checkoutButton.disabled = true;
                cartCountEl.classList.add('hidden');
            } else {
                cartPlaceholder.classList.add('hidden');
                checkoutButton.disabled = false;
                cartCountEl.classList.remove('hidden');
                cartItems.forEach(item => {
                    const availableStock = item.stock - item.quantity;
                    const incrementDisabled = availableStock <= 0;
                    const incrementClass = incrementDisabled ? 'text-gray-400 cursor-not-allowed' : 'text-gray-500 hover:text-gray-700 hover:bg-gray-200';
                    
                    const itemEl = document.createElement('div');
                    itemEl.className = 'cart-item flex items-center justify-between p-3 bg-gray-50 rounded-lg shadow-sm';
                    
                    itemEl.innerHTML = `
                        <div class="flex-1 pr-2">
                            <h4 class="font-medium text-gray-800">${item.name} ${item.variantName ? `<span class="text-xs text-gray-500">(${item.variantName})</span>` : ''}</h4>
                            <p class="text-sm text-gray-500">${currencyFormatter.format(item.price)}</p>
                            <p class="text-xs text-gray-400">Stok sisa: <span class="${availableStock <= 0 ? 'text-red-500' : ''}">${availableStock}</span></p>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button data-id="${item.uniqueId}" class="decrement-quantity text-gray-500 hover:text-gray-700 font-bold p-1 rounded-full hover:bg-gray-200 transition">&ndash;</button>
                            <span class="text-lg font-bold w-6 text-center text-gray-800">${item.quantity}</span>
                            <button data-id="${item.id}" data-variant="${item.variantName || ''}" class="increment-quantity font-bold p-1 rounded-full transition ${incrementClass}" ${incrementDisabled ? 'disabled' : ''}>+</button>
                        </div>
                    `;
                    cartItemsList.appendChild(itemEl);
                });
            }
            calculateTotal();
            updateCartCount();
            
            document.querySelectorAll('.decrement-quantity').forEach(button => button.addEventListener('click', (e) => decrementQuantity(e.target.dataset.id)));
            document.querySelectorAll('.increment-quantity').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = parseInt(e.target.dataset.id);
                    const variantName = e.target.dataset.variant || null;
                    updateCartItem(productId, variantName);
                });
            });
        }
        
        // --- MODAL VARIAN BARU ---
        
        function openVariantModal(productId, variants) {
            selectedVariantId = productId;
            const product = products.find(p => p.id === productId);
            if (!product) return;

            variantModalTitle.textContent = `Pilih Varian ${product.name}`;
            variantOptionsContainer.innerHTML = '';
            addVariantToCartButton.disabled = true; // Nonaktifkan sampai varian dipilih

            variants.forEach(variant => {
                const uniqueId = `${productId}-${variant.name}`;
                const quantityInCart = cart[uniqueId]?.quantity || 0;
                const availableStock = variant.stock - quantityInCart;
                const isOutOfStock = availableStock <= 0;
                
                const optionEl = document.createElement('label');
                optionEl.className = `flex items-center justify-between p-3 rounded-lg bg-white shadow-sm border border-gray-200 cursor-pointer transition ${isOutOfStock ? 'bg-red-50' : 'hover:bg-gray-100'}`;
                
                optionEl.innerHTML = `
                    <div class="flex items-center">
                        <input type="radio" name="selectedVariant" value="${variant.name}" data-stock="${availableStock}" class="form-radio text-gray-800 focus:ring-gray-500" ${isOutOfStock ? 'disabled' : ''}>
                        <span class="ml-3 text-sm font-medium text-gray-700">${variant.name}</span>
                    </div>
                    <div class="text-right">
                        <span class="text-sm font-bold text-gray-800">${currencyFormatter.format(variant.price)}</span>
                        <p class="text-xs text-gray-500 mt-1 ${isOutOfStock ? 'text-red-500' : ''}">${isOutOfStock ? 'Stok Habis' : `Stok: ${availableStock}`}</p>
                    </div>
                `;
                variantOptionsContainer.appendChild(optionEl);
            });

            variantModal.classList.remove('hidden');

            // Event listener untuk pilihan radio button di modal
            document.querySelectorAll('input[name="selectedVariant"]').forEach(radio => {
                radio.addEventListener('change', () => {
                    const selectedStock = parseInt(radio.dataset.stock);
                    addVariantToCartButton.disabled = selectedStock <= 0;
                });
            });
        }

        // --- UPLOAD FILE KE DRIVE ---

        /**
         * Mengubah file gambar menjadi base64 dan mengunggahnya via Apps Script.
         * @returns {Promise<string>} URL gambar yang diunggah.
         */
        function uploadProofImage() {
            return new Promise((resolve, reject) => {
                const file = paymentProofFile.files[0];
                if (!file) {
                    // Jika tidak ada file, resolve dengan string kosong, nanti akan jadi N/A
                    resolve("");
                    return;
                }

                uploadStatusEl.textContent = 'Mengunggah file...';
                uploadStatusEl.classList.remove('hidden');

                const reader = new FileReader();
                reader.readAsDataURL(file);

                reader.onload = function () {
                    const base64Content = reader.result.split(',')[1];
                    
                    fetch("https://script.google.com/macros/s/AKfycbzPsZGLIA1MOLMmc_63mFcNHmoCVALlCBtZ6PuV5gPYfss3VAjBKvAnYJceHbAOXkNK/exec", {
                        method: "POST",
                        body: JSON.stringify({
                            action: "uploadImage",
                            image: base64Content,
                            contentType: file.type,
                            filename: file.name
                        }),
                        headers: {
                             "Content-Type": "text/plain;charset=utf-8"
                        },
                        redirect: "follow"
                    })
                    .then(response => {
                        if (!response.ok) throw new Error('Upload Network failed');
                        return response.json();
                    })
                    .then(result => {
                        if (result.success) {
                            uploadStatusEl.textContent = 'Upload berhasil!';
                            resolve(result.imageUrl);
                        } else {
                            throw new Error(result.error || 'Gagal mengunggah gambar ke Drive.');
                        }
                    })
                    .catch(error => {
                        uploadStatusEl.textContent = `Gagal upload: ${error.message}`;
                        reject(error);
                    });
                };

                reader.onerror = function (error) {
                    uploadStatusEl.textContent = 'Gagal membaca file.';
                    reject(error);
                };
            });
        }

        // --- FUNGSI SUBMIT (Diperbarui untuk Upload Drive) ---

        async function submitOrder(orderDetails) {
             const selectedPaymentMethod = orderDetails.paymentMethod;
             let proofUrl = 'N/A';
             
             // 1. Proses Upload Bukti Pembayaran jika diperlukan
             if (['QRIS', 'BSI'].includes(selectedPaymentMethod)) {
                 if (paymentProofFile.files.length === 0) {
                     showModal('Bukti Pembayaran Diperlukan', 'Harap unggah file bukti pembayaran Anda.', false);
                     return;
                 }
                 try {
                     proofUrl = await uploadProofImage();
                 } catch (e) {
                     onFailure(e);
                     return; // Hentikan proses jika upload gagal
                 }
             }

             // 2. Kirim Pesanan ke Apps Script
             orderDetails.paymentProofUrl = proofUrl; // Tambahkan URL bukti pembayaran

             fetch("https://script.google.com/macros/s/AKfycbzPsZGLIA1MOLMmc_63mFcNHmoCVALlCBtZ6PuV5gPYfss3VAjBKvAnYJceHbAOXkNK/exec", {
                 method: "POST",
                 body: JSON.stringify({
                     action: "processOrder",
                     data: orderDetails
                 }),
                 headers: {
                     "Content-Type": "text/plain;charset=utf-8"
                 },
                 redirect: "follow"
             })
             .then(response => {
                 if (!response.ok) throw new Error('Network response was not ok');
                 return response.json();
             })
             .then(response => onSuccess(response, orderDetails))
             .catch(error => onFailure(error));
        }

        function onSuccess(response, orderDetails) {
            const orderNumber = response.orderNumber;
            
            submitText.classList.remove('hidden');
            submitLoader.classList.add('hidden');
            placeOrderButton.disabled = false;
            
            const message = `Terima kasih! Pesanan Anda telah berhasil dibuat. Nomor Pesanan: <strong>#${orderNumber}</strong>. Mohon cek WhatsApp untuk informasi pelacakan lebih lanjut.`;
            showModal("Pemesanan Berhasil", message, true, orderNumber);
            
            const waMessage = generateWhatsAppMessage({ ...orderDetails, orderNumber: orderNumber, status: 'Menunggu Konfirmasi' });
            const adminPhoneNumber = '6285317199124'; // Ganti dengan nomor WhatsApp admin toko
            whatsappButton.href = `https://wa.me/${adminPhoneNumber}?text=${waMessage}`;
            whatsappButton.classList.remove('hidden');
            
            // Reset state
            checkoutForm.reset();
            localStorage.removeItem('cart');
            cart = {};
            renderCart();
            renderProducts(products); 
            checkoutSidebar.classList.add('translate-x-full');
            
            // Reset tampilan pembayaran dan upload
            qrisContainer.classList.add('hidden');
            bsiContainer.classList.add('hidden');
            paymentDetailsContainer.classList.add('hidden');
            uploadProofContainer.classList.add('hidden');
            uploadStatusEl.classList.add('hidden');
            paymentProofFile.value = '';
            
            // Reset preview
            previewContainer.classList.remove('show');
        }

        function onFailure(error) {
            submitText.classList.remove('hidden');
            submitLoader.classList.add('hidden');
            placeOrderButton.disabled = false;
            console.error("Error:", error);
            showModal("Terjadi Kesalahan", `Terjadi kesalahan saat memproses pesanan Anda. Coba lagi atau hubungi admin.`, false);
        }

        // --- LISTENERS ---

        // Preview Gambar Bukti Pembayaran
        paymentProofFile.addEventListener('change', function() {
            const file = this.files[0];
            
            if (file) {
                // Validasi tipe file
                if (!file.type.match('image.*')) {
                    showModal('File Tidak Valid', 'Harap pilih file gambar (JPG/PNG).', false);
                    this.value = '';
                    return;
                }
                
                // Validasi ukuran file (maksimal 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    showModal('Ukuran File Terlalu Besar', 'Ukuran file maksimal adalah 5MB.', false);
                    this.value = '';
                    return;
                }
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    previewImage.src = e.target.result;
                    previewContainer.classList.add('show');
                };
                
                reader.readAsDataURL(file);
            } else {
                previewContainer.classList.remove('show');
            }
        });
        
        // Tombol hapus preview
        removePreviewBtn.addEventListener('click', function() {
            paymentProofFile.value = '';
            previewContainer.classList.remove('show');
        });

        // Varian Modal Listeners
        closeVariantModalButton.addEventListener('click', () => { variantModal.classList.add('hidden'); });

        addVariantToCartButton.addEventListener('click', () => {
            const selectedRadio = document.querySelector('input[name="selectedVariant"]:checked');
            if (selectedRadio) {
                const variantName = selectedRadio.value;
                updateCartItem(selectedVariantId, variantName);
                variantModal.classList.add('hidden');
            }
        });

        // Copy Account Number
        copyAccountBtn.addEventListener('click', () => {
            const accountNumber = '1042896434';
            navigator.clipboard.writeText(accountNumber)
                .then(() => {
                    copyAccountBtn.classList.add('show');
                    setTimeout(() => {
                        copyAccountBtn.classList.remove('show');
                    }, 2000);
                })
                .catch(err => {
                    console.error('Gagal menyalin nomor rekening: ', err);
                    alert('Gagal menyalin nomor rekening. Silakan salin secara manual.');
                });
        });

        // Checkout & Payment Listeners
        checkoutForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            submitText.classList.add('hidden');
            submitLoader.classList.remove('hidden');
            placeOrderButton.disabled = true;

            const orderDetails = {
                customerName: document.getElementById('customerName').value,
                customerNumber: document.getElementById('customerNumber').value,
                customerAddress: document.getElementById('customerAddress').value,
                paymentMethod: document.querySelector('input[name="paymentMethod"]:checked')?.value || 'COD',
                items: Object.values(cart)
            };

            submitOrder(orderDetails);
        });

        paymentMethodRadios.forEach(radio => {
            radio.addEventListener('change', (e) => {
                const method = e.target.value;
                
                paymentDetailsContainer.classList.add('hidden');
                qrisContainer.classList.add('hidden');
                bsiContainer.classList.add('hidden');
                uploadProofContainer.classList.add('hidden');
                
                // Reset file input dan status
                paymentProofFile.value = '';
                uploadStatusEl.classList.add('hidden');
                previewContainer.classList.remove('show');

                if (method === "QRIS") {
                    document.getElementById('qris-image-checkout').src = qrisUrl;
                    qrisContainer.classList.remove('hidden');
                    paymentDetailsContainer.classList.remove('hidden');
                    uploadProofContainer.classList.remove('hidden');
                } else if (method === "BSI") {
                    bsiContainer.classList.remove('hidden');
                    paymentDetailsContainer.classList.remove('hidden');
                    uploadProofContainer.classList.remove('hidden');
                }
            });
        });
        
        cartIconButton.addEventListener('click', () => { cartSidebar.classList.remove('translate-x-full'); });
        closeCartButton.addEventListener('click', () => { cartSidebar.classList.add('translate-x-full'); });
        checkoutButton.addEventListener('click', () => {
            cartSidebar.classList.add('translate-x-full');
            checkoutSidebar.classList.remove('translate-x-full');
            renderOrderSummary();
            // Load customer data when checkout is opened
            loadCustomerData();
        });
        closeCheckoutButton.addEventListener('click', () => {
            checkoutSidebar.classList.add('translate-x-full');
            cartSidebar.classList.remove('translate-x-full');
        });
        modalClose.addEventListener('click', hideModal);

        // --- UTILITIES (renderOrderSummary, showModal, generateWhatsAppMessage) ---
        
        function renderOrderSummary() {
            orderItemsList.innerHTML = '';
            const cartItems = Object.values(cart);
            if (cartItems.length === 0) {
                orderItemsList.innerHTML = `<p class="text-center text-gray-400">Keranjang Anda kosong.</p>`;
                orderTotalEl.textContent = currencyFormatter.format(0);
                placeOrderButton.disabled = true;
                return;
            }
            
            const total = cartItems.reduce((sum, item) => {
                const itemTotal = item.price * item.quantity;
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center text-gray-600 p-2 rounded-lg bg-white shadow-sm';
                li.innerHTML = `
                    <span class="font-medium">${item.name} ${item.variantName ? `(${item.variantName})` : ''} <span class="text-xs text-gray-400">(${item.quantity}x)</span></span>
                    <span class="font-bold">${currencyFormatter.format(item.price * item.quantity)}</span>
                `;
                orderItemsList.appendChild(li);
                return sum + itemTotal;
            }, 0);
            orderTotalEl.textContent = currencyFormatter.format(total);
            placeOrderButton.disabled = false;
        }

        function showModal(title, message, isSuccess = true, orderNumber = null) {
            modalTitle.textContent = title;
            modalTitle.className = `text-xl font-bold mb-4 ${isSuccess ? 'text-gray-800' : 'text-red-600'}`;
            modalMessage.innerHTML = message;

            if (isSuccess && orderNumber) {
                const currentDomain = window.location.origin;
                const path = window.location.pathname.replace(/\/[^/]*$/, ''); 
                const trackingLink = `${currentDomain}${path}/StatusPesanan.html?kode=${orderNumber}`;

                modalLink.href = trackingLink;
                modalLink.classList.remove('hidden');
            } else {
                modalLink.classList.add('hidden');
            }

            modal.classList.remove('hidden');
        }

        function hideModal() { 
            modal.classList.add('hidden');
            whatsappButton.classList.add('hidden');
        }

function generateWhatsAppMessage(orderDetails) {
    const items = orderDetails.items.map(item => `â¢ ${item.name}${item.variantName ? ' (' + item.variantName + ')' : ''} x${item.quantity}`).join('\n');
    const totalPrice = currencyFormatter.format(orderDetails.items.reduce((sum, item) => sum + (item.price * item.quantity), 0));
    const status = orderDetails.status || 'Menunggu Konfirmasi';
    const paymentProof = orderDetails.paymentProofUrl && orderDetails.paymentProofUrl !== 'N/A' ? `\nBukti Transfer: ${orderDetails.paymentProofUrl}` : '';

    const currentDomain = window.location.origin;
    const path = window.location.pathname.replace(/\/[^/]*$/, ''); 
    const trackingLink = `${currentDomain}${path}/StatusPesanan.html?kode=${orderDetails.orderNumber}`;

    const message = `Halo Admin, saya telah membuat pesanan.
*Nomor Pesanan:* ${orderDetails.orderNumber}
Tanggal: ${new Date().toLocaleDateString('id-ID')}
Nama Pelanggan: ${orderDetails.customerName}
Nomor Telepon: ${orderDetails.customerNumber}
Alamat: ${orderDetails.customerAddress}
Metode Pembayaran: ${orderDetails.paymentMethod}${paymentProof}
*Ringkasan Pesanan:*
 ${items}
*Total Harga:*
 ${totalPrice}
*Status:*
 ${status}
*Lihat Status Pesanan:*
 ${trackingLink}`;

    return encodeURIComponent(message);
}
        
        // --- FUNGSI UNTUK MENYIMPAN DAN MEMUAT DATA PELANGGAN ---
        
        function saveCustomerData() {
            const customerData = {
                name: document.getElementById('customerName').value,
                number: document.getElementById('customerNumber').value,
                address: document.getElementById('customerAddress').value
            };
            localStorage.setItem('balanjaCustomerData', JSON.stringify(customerData));
        }

        function loadCustomerData() {
            const savedData = localStorage.getItem('balanjaCustomerData');
            if (savedData) {
                try {
                    const customerData = JSON.parse(savedData);
                    document.getElementById('customerName').value = customerData.name || '';
                    document.getElementById('customerNumber').value = customerData.number || '';
                    document.getElementById('customerAddress').value = customerData.address || '';
                } catch (e) {
                    console.error("Failed to parse customer data from local storage", e);
                }
            }
        }
        
        // --- FUNGSI NOTIFIKASI POPUP YANG DIPERBAIKI ---
        function showNotificationPopup(customerName, productName, fullDateTime) {
    const notificationId = 'notification-' + Date.now();
    
    const notificationItem = document.createElement('div');
    notificationItem.id = notificationId;
    notificationItem.className = 'notification-item';
    
    const avatarSeed = customerName.replace(/\s/g, '').toLowerCase();
    const avatarUrl = `https://picsum.photos/seed/${avatarSeed}/50/50.jpg`;
    
    notificationItem.innerHTML = `
        <div class="notification-avatar">
            <img src="${avatarUrl}" alt="${customerName}" class="w-full h-full object-cover">
        </div>
        <div class="notification-content">
            <div class="notification-title">
                <strong>${customerName}</strong> baru saja membeli
            </div>
            <div class="notification-message">
                ${productName}
            </div>
            <!-- Tampilkan string tanggal langsung -->
            <div class="notification-time">
                ${fullDateTime}
            </div>
        </div>
        <button class="notification-close">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Tambahkan notifikasi ke container
    notificationContainer.appendChild(notificationItem);
    
    // Tambahkan ke array notifikasi aktif
    notifications.push({
        id: notificationId,
        element: notificationItem,
        timeout: null
    });
    
    // Tampilkan notifikasi dengan animasi
    setTimeout(() => {
        notificationItem.classList.add('show');
    }, 100);
    
    // Tambahkan event listener untuk tombol tutup
    const closeButton = notificationItem.querySelector('.notification-close');
    closeButton.addEventListener('click', () => {
        removeNotification(notificationId);
    });
    
    // Atur timeout untuk menghapus notifikasi setelah 7 detik
    const timeout = setTimeout(() => {
        removeNotification(notificationId);
    }, 7000);
    
    // Simpan timeout ke array notifikasi
    const notification = notifications.find(n => n.id === notificationId);
    if (notification) {
        notification.timeout = timeout;
    }
    
    // Batasi jumlah notifikasi yang ditampilkan
    if (notifications.length > 3) {
        removeNotification(notifications[0].id);
    }
}
        function removeNotification(notificationId) {
            const notificationIndex = notifications.findIndex(n => n.id === notificationId);
            if (notificationIndex === -1) return;
            
            const notification = notifications[notificationIndex];
            
            // Hapus timeout jika ada
            if (notification.timeout) {
                clearTimeout(notification.timeout);
            }
            
            // Tambahkan animasi keluar
            notification.element.classList.remove('show');
            
            // Hapus notifikasi setelah animasi selesai
            setTimeout(() => {
                if (notification.element.parentNode) {
                    notification.element.parentNode.removeChild(notification.element);
                }
            }, 500);
            
            // Hapus dari array
            notifications.splice(notificationIndex, 1);
        }
        
function checkForNewOrders() {
    fetch("https://script.google.com/macros/s/AKfycbzPsZGLIA1MOLMmc_63mFcNHmoCVALlCBtZ6PuV5gPYfss3VAjBKvAnYJceHbAOXkNK/exec?action=getOrders")
    .then(response => response.json())
    .then(data => {
        // Tambahkan log untuk debugging
        console.log("Data dari sheet Pesanan:", data);
        
        // Pastikan data adalah array
        if (!Array.isArray(data)) {
            console.error("Data dari bukan array:", data);
            return;
        }
        
        if (data.length > lastOrderCount) {
            // Ada pesanan baru
            const newOrders = data.slice(0, data.length - lastOrderCount);
            
            // Proses setiap pesanan baru
            newOrders.forEach(order => {
                // --- PERUBAAN DIMULAI DI SINI ---
                
                // Gunakan string tanggal langsung dari Apps Script
                // Contoh format: "07 Des 2025 17:55"
                const fullDateTime = order.Tanggal; 
                
                // Jika tanggal tidak ada, hentikan proses untuk notifikasi ini
                if (!fullDateTime) {
                    console.error("Data Tanggal tidak ditemukan untuk order:", order["Order Number"]);
                    return;
                }
                
                // Proses data Items (JSON) untuk menampilkan nama produk
                let productName = "beberapa produk";
                try {
                    // Pastikan kita mengakses key yang benar dari respons JSON
                    const items = order["Items (JSON)"]; 
                    if (items && items.length > 0) {
                        if (items.length === 1) {
                            productName = items[0].name;
                            if (items[0].variantName) {
                                productName += ` (${items[0].variantName})`;
                            }
                        } else {
                            productName = `${items.length} produk`;
                        }
                    }
                } catch (e) {
                    console.error("Error parsing items JSON:", e);
                }
                
                // Tampilkan notifikasi dengan data yang sudah benar
                showNotificationPopup(
                    order["Nama Pelanggan"], 
                    productName,
                    fullDateTime // Gunakan string tanggal lengkap langsung
                );
                
                // --- PERUBAEKN SELESAI DI SINI ---
            });
            
            // Update lastOrderCount
            lastOrderCount = data.length;
        }
    })
    .catch(error => {
        console.error("Error checking for new orders:", error);
    });
}
        
        // --- INITIALIZATION ---

        document.addEventListener('DOMContentLoaded', () => {
            fetch("https://script.google.com/macros/s/AKfycbzPsZGLIA1MOLMmc_63mFcNHmoCVALlCBtZ6PuV5gPYfss3VAjBKvAnYJceHbAOXkNK/exec")
            .then(response => {
                if (!response.ok) throw new Error('Failed to fetch products');
                return response.json();
            })
            .then(data => {
                products = data.products.map(p => ({ 
                    ...p, 
                    id: parseInt(p.id)
                }));
                qrisUrl = data.qrisUrl;
                loadCart();
                renderProducts(products);
                renderCart();
                
                // Dapatkan jumlah pesanan awal
                fetch("https://script.google.com/macros/s/AKfycbzPsZGLIA1MOLMmc_63mFcNHmoCVALlCBtZ6PuV5gPYfss3VAjBKvAnYJceHbAOXkNK/exec?action=getOrders")
                .then(response => response.json())
                .then(data => {
                    lastOrderCount = data.length;
                    
                    // Periksa pesanan baru setiap 30 detik
                    setInterval(checkForNewOrders, 30000);
                    
                    // Jalankan pemeriksaan pertama kali setelah 5 detik
                    setTimeout(checkForNewOrders, 5000);
                })
                .catch(error => {
                    console.error("Error fetching initial order count:", error);
                });
            })
            .catch(error => {
                loadingMessage.innerHTML = `<p class="text-red-600">Gagal memuat produk. Pastikan URL Apps Script sudah benar dan dideploy dengan benar.</p>`;
                productsList.classList.remove('hidden');
                loadingMessage.classList.remove('hidden');
                console.error("Error fetching products:", error);
            });
        });
    </script>
</body>
</html>
